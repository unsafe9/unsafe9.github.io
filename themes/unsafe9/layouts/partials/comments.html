{{- if not .Params.disableComments }}
<div class="comments-section">
    <h3>Comments</h3>

    {{- /* Giscus Configuration */}}
    {{- if .Site.Params.giscus.repo }}
    <div class="giscus"></div>
    <script>
      (function() {
        function getGiscusTheme() {
          const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
          // Always use custom CSS for consistent theme
          return isDark
            ? '{{ absURL "giscus-dark.css" }}?v=10'
            : '{{ absURL "giscus-light.css" }}?v=10';
        }

        function updateGiscusTheme() {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;

          const theme = getGiscusTheme();
          iframe.contentWindow.postMessage(
            { giscus: { setConfig: { theme: theme } } },
            'https://giscus.app'
          );
        }

        // Load Giscus after theme is initialized
        document.addEventListener('DOMContentLoaded', () => {
          // Wait for theme.js to initialize
          setTimeout(() => {
            const container = document.querySelector('.giscus');
            if (!container) return;

            const script = document.createElement('script');
            script.src = 'https://giscus.app/client.js';
            script.setAttribute('data-repo', '{{ .Site.Params.giscus.repo }}');
            script.setAttribute('data-repo-id', '{{ .Site.Params.giscus.repoId }}');
            script.setAttribute('data-category', '{{ .Site.Params.giscus.category | default "General" }}');
            script.setAttribute('data-category-id', '{{ .Site.Params.giscus.categoryId }}');
            script.setAttribute('data-mapping', '{{ .Site.Params.giscus.mapping | default "pathname" }}');
            script.setAttribute('data-strict', '{{ .Site.Params.giscus.strict | default "0" }}');
            script.setAttribute('data-reactions-enabled', '{{ .Site.Params.giscus.reactionsEnabled | default "1" }}');
            script.setAttribute('data-emit-metadata', '{{ .Site.Params.giscus.emitMetadata | default "0" }}');
            script.setAttribute('data-input-position', '{{ .Site.Params.giscus.inputPosition | default "bottom" }}');
            script.setAttribute('data-theme', getGiscusTheme());
            script.setAttribute('data-lang', '{{ .Site.Params.giscus.lang | default "en" }}');
            script.setAttribute('crossorigin', 'anonymous');
            script.async = true;

            container.appendChild(script);
          }, 150);
        });

        // Update Giscus theme when site theme changes using postMessage
        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            if (mutation.attributeName === 'data-theme') {
              updateGiscusTheme();
            }
          });
        });

        observer.observe(document.documentElement, {
          attributes: true,
          attributeFilter: ['data-theme']
        });
      })();
    </script>
    {{- else }}
    <div class="comments-placeholder">
        <p>Comments are powered by Giscus. To enable comments:</p>
        <ol>
            <li>Create a public GitHub repository for discussions</li>
            <li>Enable Discussions in your repository settings</li>
            <li>Install the <a href="https://github.com/apps/giscus" target="_blank" rel="noopener">Giscus app</a></li>
            <li>Visit <a href="https://giscus.app" target="_blank" rel="noopener">giscus.app</a> to generate your configuration</li>
            <li>Add the configuration to your <code>config.toml</code> under <code>[params.giscus]</code></li>
        </ol>
    </div>
    {{- end }}
</div>
{{- end }}
