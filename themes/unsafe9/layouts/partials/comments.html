{{- if not .Params.disableComments }}
<div class="comments-section">
    <h3>Comments</h3>

    {{- /* Giscus Configuration */}}
    {{- if .Site.Params.giscus.repo }}
    <div class="giscus"></div>
    <script>
      function loadGiscus() {
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';

        // Use HTTPS URLs for production (GitHub Pages) and built-in themes for local development
        const isProduction = window.location.hostname !== 'localhost';
        const giscusTheme = isDark
          ? (isProduction ? '{{ absURL "giscus-dark.css" }}?v=6' : 'dark')
          : (isProduction ? '{{ absURL "giscus-light.css" }}?v=6' : 'light');

        const script = document.createElement('script');
        script.src = 'https://giscus.app/client.js';
        script.setAttribute('data-repo', '{{ .Site.Params.giscus.repo }}');
        script.setAttribute('data-repo-id', '{{ .Site.Params.giscus.repoId }}');
        script.setAttribute('data-category', '{{ .Site.Params.giscus.category | default "General" }}');
        script.setAttribute('data-category-id', '{{ .Site.Params.giscus.categoryId }}');
        script.setAttribute('data-mapping', '{{ .Site.Params.giscus.mapping | default "pathname" }}');
        script.setAttribute('data-strict', '{{ .Site.Params.giscus.strict | default "0" }}');
        script.setAttribute('data-reactions-enabled', '{{ .Site.Params.giscus.reactionsEnabled | default "1" }}');
        script.setAttribute('data-emit-metadata', '{{ .Site.Params.giscus.emitMetadata | default "0" }}');
        script.setAttribute('data-input-position', '{{ .Site.Params.giscus.inputPosition | default "bottom" }}');
        script.setAttribute('data-theme', giscusTheme);
        script.setAttribute('data-lang', '{{ .Site.Params.giscus.lang | default "en" }}');
        script.setAttribute('crossorigin', 'anonymous');
        script.async = true;

        document.querySelector('.giscus').appendChild(script);
      }

      // Load Giscus on page load
      loadGiscus();

      // Update Giscus theme when site theme changes
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.attributeName === 'data-theme') {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const isProduction = window.location.hostname !== 'localhost';
            const theme = isDark
              ? (isProduction ? '{{ absURL "giscus-dark.css" }}?v=6' : 'dark')
              : (isProduction ? '{{ absURL "giscus-light.css" }}?v=6' : 'light');

            // Wait for iframe to be ready
            const checkIframe = setInterval(() => {
              const iframe = document.querySelector('iframe.giscus-frame');
              if (iframe && iframe.contentWindow) {
                iframe.contentWindow.postMessage(
                  { giscus: { setConfig: { theme } } },
                  'https://giscus.app'
                );
                clearInterval(checkIframe);
              }
            }, 100);

            // Clear interval after 5 seconds to prevent memory leaks
            setTimeout(() => clearInterval(checkIframe), 5000);
          }
        });
      });

      observer.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ['data-theme']
      });
    </script>
    {{- else }}
    <div class="comments-placeholder">
        <p>Comments are powered by Giscus. To enable comments:</p>
        <ol>
            <li>Create a public GitHub repository for discussions</li>
            <li>Enable Discussions in your repository settings</li>
            <li>Install the <a href="https://github.com/apps/giscus" target="_blank" rel="noopener">Giscus app</a></li>
            <li>Visit <a href="https://giscus.app" target="_blank" rel="noopener">giscus.app</a> to generate your configuration</li>
            <li>Add the configuration to your <code>config.toml</code> under <code>[params.giscus]</code></li>
        </ol>
    </div>
    {{- end }}
</div>
{{- end }}
